name: Deploy to Server (SSH)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - homologation
          - production
      branch:
        description: 'Branch to deploy'
        required: true
        type: string
        default: 'develop'
      confirmation:
        description: 'For PRODUCTION: type "DEPLOY-TO-PRODUCTION"'
        required: false
        type: string

env:
  REGISTRY: localhost:5000
  IMAGE_NAME: goshortener

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      cluster_name: ${{ steps.set-env.outputs.cluster_name }}
      namespace: ${{ steps.set-env.outputs.namespace }}
      replicas: ${{ steps.set-env.outputs.replicas }}
      image_tag_prefix: ${{ steps.set-env.outputs.image_tag_prefix }}
      ssh_host: ${{ steps.set-env.outputs.ssh_host }}
      ssh_port: ${{ steps.set-env.outputs.ssh_port }}
    
    steps:
      - name: Set Environment Variables
        id: set-env
        run: |
          ENV="${{ github.event.inputs.environment }}"
          BRANCH="${{ github.event.inputs.branch }}"
          
          echo "üîß Configurando deploy para: $ENV (branch: $BRANCH)"
          
          # Valida√ß√µes espec√≠ficas por ambiente
          if [ "$ENV" == "production" ]; then
            # Validar confirma√ß√£o para produ√ß√£o
            if [ "${{ github.event.inputs.confirmation }}" != "DEPLOY-TO-PRODUCTION" ]; then
              echo "‚ùå Deploy em PRODU√á√ÉO requer confirma√ß√£o!"
              echo "Digite exatamente: DEPLOY-TO-PRODUCTION"
              exit 1
            fi
            echo "‚úÖ Confirma√ß√£o de produ√ß√£o validada"
            
            # Produ√ß√£o: branch deve ser main ou hotfix
            if [[ "$BRANCH" != "main" ]] && [[ "$BRANCH" != hotfix/* ]]; then
              echo "‚ùå Produ√ß√£o s√≥ aceita branch 'main' ou 'hotfix/*'"
              exit 1
            fi
            
            echo "cluster_name=goshortener-prd" >> $GITHUB_OUTPUT
            echo "namespace=goshortener-prd" >> $GITHUB_OUTPUT
            echo "replicas=3" >> $GITHUB_OUTPUT
            echo "image_tag_prefix=prd" >> $GITHUB_OUTPUT
            
          else
            # Homologa√ß√£o
            echo "cluster_name=goshortener-hml" >> $GITHUB_OUTPUT
            echo "namespace=goshortener-hml" >> $GITHUB_OUTPUT
            echo "replicas=2" >> $GITHUB_OUTPUT
            echo "image_tag_prefix=hml" >> $GITHUB_OUTPUT
          fi
          
          # SSH Configuration (mesma para ambos ambientes)
          echo "ssh_host=${{ secrets.SSH_HOST }}" >> $GITHUB_OUTPUT
          echo "ssh_port=${{ secrets.SSH_PORT || '22' }}" >> $GITHUB_OUTPUT

  build:
    needs: setup
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker Image
        run: |
          TAG_PREFIX="${{ needs.setup.outputs.image_tag_prefix }}"
          
          echo "üê≥ Construindo imagem..."
          
          docker build \
            --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
            --build-arg VCS_REF=${{ github.sha }} \
            --build-arg VERSION=${{ github.event.inputs.branch }} \
            --build-arg ENVIRONMENT=${{ github.event.inputs.environment }} \
            -t ${{ env.IMAGE_NAME }}:${TAG_PREFIX}-${{ github.sha }} \
            -t ${{ env.IMAGE_NAME }}:${TAG_PREFIX}-latest \
            --load \
            .
          
          echo "‚úÖ Imagem constru√≠da!"
      
      - name: Save Docker Image
        run: |
          TAG_PREFIX="${{ needs.setup.outputs.image_tag_prefix }}"
          
          echo "üíæ Salvando imagem para transfer√™ncia..."
          docker save ${{ env.IMAGE_NAME }}:${TAG_PREFIX}-${{ github.sha }} | gzip > image.tar.gz
          
          echo "üìä Tamanho da imagem:"
          ls -lh image.tar.gz
      
      - name: Upload Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: image.tar.gz
          retention-days: 1

  deploy:
    needs: [setup, build]
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
      
      - name: Download Image Artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Add host to known_hosts
          ssh-keyscan -p ${{ needs.setup.outputs.ssh_port }} ${{ needs.setup.outputs.ssh_host }} >> ~/.ssh/known_hosts
          
          echo "‚úÖ SSH configurado!"
      
      - name: Transfer Docker Image
        run: |
          echo "üì§ Transferindo imagem para servidor..."
          
          scp -i ~/.ssh/deploy_key \
            -P ${{ needs.setup.outputs.ssh_port }} \
            image.tar.gz \
            ${{ secrets.SSH_USER }}@${{ needs.setup.outputs.ssh_host }}:/tmp/goshortener-image.tar.gz
          
          echo "‚úÖ Imagem transferida!"
      
      - name: Deploy to Server
        run: |
          CLUSTER_NAME="${{ needs.setup.outputs.cluster_name }}"
          NAMESPACE="${{ needs.setup.outputs.namespace }}"
          TAG_PREFIX="${{ needs.setup.outputs.image_tag_prefix }}"
          REPLICAS="${{ needs.setup.outputs.replicas }}"
          
          echo "üöÄ Executando deploy no servidor..."
          
          ssh -i ~/.ssh/deploy_key \
            -p ${{ needs.setup.outputs.ssh_port }} \
            ${{ secrets.SSH_USER }}@${{ needs.setup.outputs.ssh_host }} \
            bash -s <<EOF
          
          set -e
          
          echo "üì¶ Carregando imagem Docker..."
          docker load < /tmp/goshortener-image.tar.gz
          
          echo "üè∑Ô∏è  Tagueando imagem para registry local..."
          docker tag ${{ env.IMAGE_NAME }}:${TAG_PREFIX}-${{ github.sha }} \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG_PREFIX}-${{ github.sha }}
          docker tag ${{ env.IMAGE_NAME }}:${TAG_PREFIX}-${{ github.sha }} \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG_PREFIX}-latest
          
          echo "üì§ Enviando para registry local..."
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG_PREFIX}-${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG_PREFIX}-latest
          
          echo "‚ò∏Ô∏è  Configurando kubectl..."
          kubectl config use-context kind-${CLUSTER_NAME}
          
          echo "üìù Criando namespace se necess√°rio..."
          kubectl create namespace ${NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -
          
          echo "üöÄ Aplicando deployment..."
          
          # Verificar se deployment existe
          if kubectl get deployment goshortener -n ${NAMESPACE} &>/dev/null; then
            echo "‚ôªÔ∏è  Atualizando deployment existente..."
            kubectl set image deployment/goshortener \
              goshortener=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG_PREFIX}-${{ github.sha }} \
              -n ${NAMESPACE}
          else
            echo "üÜï Criando novo deployment..."
            kubectl create deployment goshortener \
              --image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG_PREFIX}-${{ github.sha }} \
              --replicas=${REPLICAS} \
              -n ${NAMESPACE}
            
            # Adicionar labels
            kubectl label deployment goshortener \
              app=goshortener \
              version=v1 \
              environment=${{ github.event.inputs.environment }} \
              -n ${NAMESPACE}
          fi
          
          echo "üîå Configurando service..."
          kubectl expose deployment goshortener \
            --port=80 \
            --target-port=8080 \
            --type=ClusterIP \
            -n ${NAMESPACE} \
            --dry-run=client -o yaml | kubectl apply -f -
          
          echo "‚è≥ Aguardando rollout..."
          kubectl rollout status deployment/goshortener -n ${NAMESPACE} --timeout=300s
          
          echo "‚úÖ Deploy conclu√≠do!"
          
          echo "üßπ Limpando arquivo tempor√°rio..."
          rm -f /tmp/goshortener-image.tar.gz
          
          EOF
      
      - name: Verify Deployment
        run: |
          NAMESPACE="${{ needs.setup.outputs.namespace }}"
          
          echo "üîç Verificando deployment no servidor..."
          
          ssh -i ~/.ssh/deploy_key \
            -p ${{ needs.setup.outputs.ssh_port }} \
            ${{ secrets.SSH_USER }}@${{ needs.setup.outputs.ssh_host }} \
            bash -s <<EOF
          
          kubectl config use-context kind-${{ needs.setup.outputs.cluster_name }}
          
          echo ""
          echo "üìä Status dos Pods:"
          kubectl get pods -n ${NAMESPACE} -l app=goshortener
          
          echo ""
          echo "üîå Status do Service:"
          kubectl get svc -n ${NAMESPACE} goshortener
          
          echo ""
          echo "üìã Deployment Info:"
          kubectl get deployment goshortener -n ${NAMESPACE}
          
          EOF
      
      - name: Cleanup SSH
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
      
      - name: Deployment Summary
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë       DEPLOYMENT SUMMARY - SERVER                             ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          echo "üåê Ambiente:       ${{ github.event.inputs.environment }}"
          echo "üì¶ Cluster:        ${{ needs.setup.outputs.cluster_name }}"
          echo "üè∑Ô∏è  Namespace:      ${{ needs.setup.outputs.namespace }}"
          echo "üåø Branch:         ${{ github.event.inputs.branch }}"
          echo "üîñ Commit:         ${{ github.sha }}"
          echo "üë§ Deployed by:    ${{ github.actor }}"
          echo "‚è∞ Deploy time:    $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "üñ•Ô∏è  Server:         ${{ secrets.SSH_HOST }}"
          echo ""
          echo "‚úÖ Aplica√ß√£o deployada no seu servidor!"
